<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MegaPlantTF Dashboard â€” {{JOBID}}</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  margin: 20px;
  background-color: #fafafa;
}
h1 { color: #1f77b4; }
.card {
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  border-radius: 10px;
  margin-bottom: 20px;
}
.table-container {
  max-height: 500px;
  overflow-y: auto;
}

/* === Slider Styling === */
.custom-slider {
  height: 8px;
  background: linear-gradient(90deg, #1f77b4 0%, #4fa3d1 100%);
  border-radius: 10px;
  outline: none;
  opacity: 0.9;
  transition: opacity 0.2s, box-shadow 0.2s;
}
.custom-slider:hover {
  opacity: 1;
  box-shadow: 0 0 8px rgba(31, 119, 180, 0.4);
}
.custom-slider::-webkit-slider-thumb {
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #1f77b4;
  border: 2px solid white;
  cursor: pointer;
  transition: background 0.2s, transform 0.2s;
}
.custom-slider::-webkit-slider-thumb:hover {
  background: #145a8d;
  transform: scale(1.1);
}
.custom-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #1f77b4;
  border: 2px solid white;
  cursor: pointer;
}
.threshold-slider-container {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #1e78b4;
  padding-left: .3em;
  border-radius: 6px;
}

/* === Table Styling === */
.seq-id {
  font-family: monospace;
}
.predicted-class {
  background-color: #d1e7dd !important; 
  font-weight: bold;
  color: #0f5132;
}
.max-prob {
  background-color: #cff4fc !important;
  font-weight: bold;
  color: #055160;
}
.prob-cell {
  text-align: right;
  color: #fff;
  font-weight: bold;
  border-radius: 4px;
  transition: all 0.3s;
}
.prob-cell:hover {
  transform: scale(1.05);
}
th,td {
    white-space: nowrap;
}

table td {
  font-weight: 300 !important; 
  color: #333;
}
table th {
  font-weight: 600 !important; 
  background-color: #e7f1fb;
  color: #0b4178;
}
table td {
  font-weight: 300 !important;
  color: #444;
}

</style>
</head>
<body>
<div class="container">
  <h1>MegaPlantTF</h1>
  <p><b>Job ID:</b> {{JOBID}} | <b>K-mer:</b> {{KMER}} | <b>Voting:</b> {{VOTING}}</p>

  <div class="row mb-3 justify-content-between">
    <div class="col-md-4">
      <label class="form-label fw-bold text-primary">Threshold:</label>
      <div class="threshold-slider-container">
        <input type="range"
               class="form-range custom-slider"
               id="thresholdSlider"
               min="0" max="1" step="0.05"
               value="{{THRESHOLD}}">
        <span id="thresholdValue" class="badge ms-2" style="background-color: #1e78b4;">{{THRESHOLD}}</span>
      </div>
    </div>
    <div class="col-md-3">
      <label class="form-label"><b>Search Gene Family:</b></label>
      <input type="text" id="searchBox" class="form-control" placeholder="Type to filter...">
    </div>
  </div>

  <div class="card p-3">
    <h4>Predicted Gene Family Distribution</h4>
        {{PLOT_HTML}}
    </div>

    <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Predictions Table</h4>
            <button id="downloadBtn" class="btn btn-primary btn-sm" style="font-size: 1.06em;">
            Download Predictions CSV
            </button>
        </div>
        <div class="table-container">
            <table class="table table-striped table-bordered align-middle" id="predTable">
            <thead class="table-primary">
                <tr id="tableHeader"></tr>
            </thead>
            <tbody></tbody>
            </table>
        </div>
    </div>
    <br><br><br>

    <!-- <div class="text-center mt-4">
        <button id="downloadBtn" class="btn btn-primary">
            Download Predictions CSV
        </button>
    </div> -->
</div>

<script>
const allData = {{DATA_JSON}};
const tableHeader = document.querySelector("#tableHeader");
const tableBody = document.querySelector("#predTable tbody");
const searchBox = document.querySelector("#searchBox");
const slider = document.querySelector("#thresholdSlider");
const threshVal = document.querySelector("#thresholdValue");

// Build header dynamically
const cols = Object.keys(allData[0]);
cols.forEach(col => {
  const th = document.createElement("th");
  th.textContent = col;
  tableHeader.appendChild(th);
});

// Map probability value to background color (blue gradient)
function getColorForProb(prob) {
    if (prob < 0.1) {
        return "#fafafa"; 
    }
    const r = Math.round(20 + 200 * (1 - prob));
    const g = Math.round(100 + 100 * (1 - prob));
    const b = 255;
    return `rgba(${r},${g},${b},0.85)`;
}

function renderTable(filterText = "", threshold = {{THRESHOLD}}) {
  tableBody.innerHTML = "";

  // Keep the same order as original Sequence_ID
  allData.forEach(row => {
    // Apply filtering logic but don't reorder
    const matchesFilter = row["Predicted_Class"].toLowerCase().includes(filterText.toLowerCase());
    const meetsThreshold = row["Max_Prob"] >= threshold;

    if (matchesFilter && meetsThreshold) {
      const tr = document.createElement("tr");
      Object.keys(row).forEach(key => {
        const td = document.createElement("td");

        if (key === "Sequence_ID") {
          td.textContent = row[key];
          td.classList.add("seq-id");
        } 
        else if (key === "Predicted_Class") {
          td.textContent = row[key];
          td.classList.add("predicted-class");
        } 
        else if (key === "Max_Prob") {
          td.textContent = row[key].toFixed(3);
          td.classList.add("max-prob");
        } 
        else if (!["Sequence_ID", "Predicted_Class", "Max_Prob"].includes(key)) {
          const prob = row[key];
          td.textContent = prob.toFixed(2);
          td.classList.add("prob-cell");
          td.style.backgroundColor = getColorForProb(prob);
        } 
        else {
          td.textContent = row[key];
        }

        tr.appendChild(td);
      });
      tableBody.appendChild(tr);
    }
  });

  threshVal.textContent = threshold.toFixed(2);
}

searchBox.addEventListener("input", () => renderTable(searchBox.value, parseFloat(slider.value)));
slider.addEventListener("input", () => renderTable(searchBox.value, parseFloat(slider.value)));
renderTable();

document.getElementById("downloadBtn").addEventListener("click", () => {
  let rows = [];
  
  // Get headers
  const headers = Array.from(document.querySelectorAll("#tableHeader th")).map(th => th.textContent);
  rows.push(headers.join(","));
  
  // Get visible rows
  document.querySelectorAll("#predTable tbody tr").forEach(tr => {
    const cells = Array.from(tr.querySelectorAll("td")).map(td => `"${td.textContent}"`);
    rows.push(cells.join(","));
  });

  // Create CSV blob
  const csvContent = rows.join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "MegaPlantTF_Filtered_Predictions.csv";
  link.click();
});
</script>
</body>
</html>
