<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MegaPlantTF Dashboard — {{JOBID}}</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #fafafa; }
h1 { color: #1f77b4; }
.card { box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 10px; margin-bottom: 20px; }
.table-container { max-height: 500px; overflow-y: auto; }
</style>
</head>
<body>
<div class="container">
    <h1>MegaPlantTF</h1>
    <p><b>Job ID:</b> {{JOBID}} | <b>K-mer:</b> {{KMER}} | <b>Voting:</b> {{VOTING}}</p>

    <div class="row mb-3">
        <div class="col-md-3">
            <label class="form-label"><b>Threshold:</b></label>
            <input type="range" class="form-range" id="thresholdSlider" min="0" max="1" step="0.05" value="{{THRESHOLD}}">
            <span id="thresholdValue">{{THRESHOLD}}</span>
        </div>
        <div class="col-md-3">
            <label class="form-label"><b>Search Gene Family:</b></label>
            <input type="text" id="searchBox" class="form-control" placeholder="Type to filter...">
        </div>
    </div>

    <div class="card p-3">
        <h4>Predicted Gene Family Distribution</h4>
        {{PLOT_HTML}}
    </div>

    <div class="card p-3">
        <h4>Predictions Table</h4>
        <div class="table-container">
            <table class="table table-striped" id="predTable">
                <thead>
                    <tr>
                        <th>Sequence_ID</th>
                        <th>Predicted_Class</th>
                        <th>Max_Prob</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="text-center mt-4">
        <a href="MegaPlantTF_Dashboard_{{JOBID}}_predictions.csv" download class="btn btn-primary">
            ⬇️ Download Predictions CSV
        </a>
    </div>
</div>

<script>
const allData = {{DATA_JSON}};
const tableBody = document.querySelector("#predTable tbody");
const searchBox = document.querySelector("#searchBox");
const slider = document.querySelector("#thresholdSlider");
const threshVal = document.querySelector("#thresholdValue");

function renderTable(filterText = "", threshold = {{THRESHOLD}}) {
    tableBody.innerHTML = "";
    let filtered = allData.filter(row => row["Predicted_Class"].toLowerCase().includes(filterText.toLowerCase()) && row["Max_Prob"] >= threshold);
    filtered.forEach(row => {
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.Sequence_ID || ""}</td>
                        <td>${row.Predicted_Class}</td>
                        <td>${row.Max_Prob.toFixed(3)}</td>`;
        tableBody.appendChild(tr);
    });
    threshVal.textContent = threshold.toFixed(2);
}
searchBox.addEventListener("input", () => renderTable(searchBox.value, parseFloat(slider.value)));
slider.addEventListener("input", () => renderTable(searchBox.value, parseFloat(slider.value)));
renderTable();
</script>
</body>
</html>
